<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<title>Visualization of price prediction for India rice market</title>
	<!-- <link rel="stylesheet" href="leaflet.css"> -->
	<link rel="stylesheet" href="custom.css">
	<link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.css' rel='stylesheet' />
	<link rel="stylesheet" href="jquery.ui.labeledslider.css">
	<link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
	<link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.0/css/font-awesome.css" rel="stylesheet">
    <link href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div id="map"></div>
<div id="credits">
    <div id="credits_box">
        <div id="credits_content">
          <span class="help-block">
			A MIRROR Twitter by <a href="#">Humanitas Team</a> at DATA and <a href="http://data.epfl.ch">DATA Lab</a> at EPFL<br/><br/>Team members: Alex, Anton, Ching-Chia, Duy, Fabian, Gabriel, Joseph and Stefan <br/> <br/> Data source: 120M geo-localized tweets obtained via Twitter public API over xy days, starting 9 April 2014 <br/>
			<img src="images/epfl_med.png" alt="EPFL"width="150" height="70">
			</span>
		</div>
	</div>
	<div id="toggle_credits" class="btn btn-inverse" type="button">Project Information</div>
</div>

<div id="dashboard">
	<div id="dashboard_box" class="control">
		<div id="dashboard_content">       
			<h5>Please choose an option</h5><br>
			<div class="slider_zone">
				<div id="slider_year" class="myslider"></div>
				<div id="slider_month" class="myslider"></div>
			</div>
			<!-- <select id="month">
				<option value="1">January</option>
				<option value="1">February</option>
				<option value="1">March</option>
				<option value="1">January</option>
				<option value="1">January</option>
				<option value="1">January</option>
				<option value="1">January</option>
				<option value="1">January</option>
				<option value="1">January</option>
				<option value="1">January</option>
				<option value="1">January</option>
				<option value="1">January</option>
				<option value="1">January</option>
			</select> -->
		</div>
	</div>
	<div id="toggle_dashboard" class="btn btn-inverse" type="button">Dashboard</div>
</div>
<!-- <script src="leaflet.js"></script> -->
<script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.js'></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
<script src="jquery.ui.labeledslider.js"></script>
<script type="text/javascript" src="ind-states.js"></script>
<script>
var colorScale = ['#FFEDA0', '#FED976', '#FEB24C', '#FD8D3C', '#FC4E2A', '#E31A1C', '#BD0026', '#800026'];
var densityScale = [10, 20, 50, 100, 200, 500, 1000];
var map, geojson, info, options, highlighted, year = 1980, month = 1;
// map = L.map('map').setView([22, 83], 4.7);
map = L.mapbox.map('map', 'examples.map-9ijuk24y').setView([22, 83], 5);
// var cloudmade = L.tileLayer('http://{s}.tiles.mapbox.com/v3/duynguyen-epfl.4ppn9udi/{z}/{x}/{y}.png', {
// 	attribution: 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade',
// 	// key: 'BC9A493B41014CAABB98F0471D759707',
// 	styleId: 22677
// }).addTo(map);

// control that shows state info on hover
info = L.control();

info.onAdd = function (map) {
	this._div = L.DomUtil.create('div', 'info');
	this.update();
	return this._div;
};

info.update = function (feature) {
	this._div.innerHTML = '<h4>India Tweets Density</h4>' +  (feature ?
		'<b>' + feature.id + '</b><br />' + (getDensity(feature.id) ? getDensity(feature.id).strength : 'N/A') + ' tweets / m<sup>2</sup>'
		: 'Hover over a state');
};

info.addTo(map);

// add legend and initiate map
addLegend(map);
drawMap();

// toggle of credits
var isCreditsVisible = true;
$('#toggle_credits').click(function(){
	$('#credits_box').slideToggle('fast');
	if(isCreditsVisible){
		$('#toggle_credits').html("Hide Information");
			isCreditsVisible = false;
		} else {
			$('#toggle_credits').html("Project Information");
			isCreditsVisible = true;
		}
});

// toggle of dashboard
var isDashboardVisible = true;
$('#toggle_dashboard').click(function(){
	$('#dashboard_box').slideToggle('fast');
	if(isDashboardVisible){
		$('#toggle_dashboard').html("Hide Dashboard");
			isDashboardVisible = false;
		} else {
			$('#toggle_dashboard').html("Dashboard");
			isDashboardVisible = true;
		}
});

// slider controller

$( "#slider_year" ).labeledslider({
	value: year,
	min: 1980,
	max: 1990,
	step: 10,
	slide: function( event, ui ) {
		year = ui.value;
		drawMap();
	}
});

$( "#slider_month" ).labeledslider({
	value: year,
	min: 1,
	max: 12,
	step: 1,
	tickLabels: {
      1:'Jan',
      2:'Feb',
      3:'Mar',
      4:'Apr',
      5:'May',
      6:'Jun',
      7:'Jul',
      8:'Aug',
      9:'Sep',
      10:'Oct',
      11:'Nov',
      12:'Dec',
    },
	slide: function( event, ui ) {
		month = ui.value;
		drawMap();
	}
}); 

function drawMap() {
	highlighted = null;
	if(geojson) {
		map.removeLayer(geojson);
	}
	geojson = L.geoJson(statesData, {
		style: stateStyle,
		onEachFeature: onEachFeature
	}).addTo(map);
}

// get color depending on population density value
function getColor(d) {
	for(i = densityScale.length; i >= 0; i--) {
		if(d > densityScale[i]) {
			return colorScale[i + 1];
		}
	}
	return colorScale[0];
}

function stateStyle(feature) {
	return {
		weight: 1,
		color: 'grey',
		dashArray: '4',
		fillOpacity: 0.6,
		fillColor: getColor(getDensity(feature.id) ? getDensity(feature.id).strength : 0)
	};
}

function getDensity(id) {
	for(i = 0; i < density.length; i++) {
		if(density[i].year == year && density[i].month == month) {
			var vals = density[i].values;
			for(j = 0; j < vals.length; j++) {
				if(vals[j].id == id) {
					return vals[j];
				}
			}
		}
	}
}

function highlightFeature(e) {
	var layer = e.target;

	if (layer && highlighted !== layer) {
		layer.setStyle({
			weight: 3,
			color: 'green',
			dashArray: '',
			fillOpacity: 0.6
		});

		// if (!L.Browser.ie && !L.Browser.opera) {
		// 	layer.bringToFront();
		// }

	}
	info.update(layer.feature);
}

function resetHighlight(e) {
	geojson.resetStyle(e.target);
	info.update();
}

function zoomToFeature(e) {
	var layer = e.target;
	if (layer && highlighted !== layer) {
		map.fitBounds(e.target.getBounds());
		highlighted = layer;
		// prev = highlighted;
		// resetHighlight(prev._container);
		// layer.setStyle({
		// 	weight: 3,
		// 	color: 'black',
		// 	dashArray: '',
		// 	fillOpacity: .4
		// });
	} else {
		map.setView([22, 83], 5);
		highlighted = null;
		// e.target.setStyle({
		// 	fillOpacity: 0.7
		// });
	}
}

function onEachFeature(feature, layer) {
	layer.on({
		mouseover: highlightFeature,
		mouseout: resetHighlight,
		click: zoomToFeature
	});
}

function addLegend(map) {
	var legend = L.control({position: 'bottomright'});

	legend.onAdd = function (map) {

		var div = L.DomUtil.create('div', 'info legend'),
			labels = [],
			from, to;

		for (var i = 0; i < densityScale.length; i++) {
			from = densityScale[i];
			to = densityScale[i + 1];

			labels.push(
				'<i style="background:' + getColor(from + 1) + '"></i> ' +
				from + (to ? '&ndash;' + to : '+'));
		}

		div.innerHTML = labels.join('<br>');
		return div;
	};

	legend.addTo(map);
}

</script>

</body>